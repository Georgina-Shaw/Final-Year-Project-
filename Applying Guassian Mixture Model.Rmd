---
title: "Applying Gaussian Mixture Model"
author: "Georgina Shaw"
date: "07/03/2022"
output: pdf_document
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
load("data/stomach_dataset.Rdata")
library(dplyr)
library(purrr)
library(tidyr)
library(ggplot2)
```

# Herrin 


Only keeping the information we need 
```{r}
df <- stom_df %>%
  transmute(Species = pred_species,
            wprey = prey_weight_g,
            wpredator = pred_weight_g,
            Nprey = prey_count / n_stomachs,
            l = log(wpredator / wprey))
```
Choosing the type of fish to use, this time looking at cod 
```{r}
stomach <- df %>%
  filter(Species == "Clupea harengus",
         wprey > 0)

stomach %>% 
  group_by(Species) %>% 
  summarise(wprey_min = min(wprey),
            wprey_max = max(wprey),
            lmin = min(l),
            lmax = max(l))

stomach %>% 
  group_by(Species) %>% 
  filter(wprey == max(wprey))
```
Creating bins for the data 
```{r}
no_bins <- 30  # Number of bins
binsize <- (max(stomach$l) - min(stomach$l)) / (no_bins - 1)
breaks <- seq(min(stomach$l) - binsize/2,
              by = binsize, length.out = no_bins + 1)
```
Splitting the data into the bins that have been made
```{r}
binned_stomach <- stomach %>% 
  # bin data
  mutate(cut = cut(l, breaks = breaks, right = FALSE,
                   labels = FALSE)) %>% 
  group_by(Species, cut) %>% 
  summarise(Numbers = sum(Nprey), 
            Biomass = sum(Nprey * wprey)) %>% 
  # normalise
  mutate(Numbers = Numbers / sum(Numbers) / binsize,
         Biomass = Biomass / sum(Biomass) / binsize)  %>%
  # column for predator/prey size ratio
  mutate(l = map_dbl(cut, function(idx) breaks[idx] + binsize/2))
binned_stomach
```
We convert this into the long table format preferred by ggplot2.
```{r}
binned_stomach <- binned_stomach %>%
  gather(key = "Type", value = "Density", Numbers, Biomass)
```
       
## Histograms 
Plot the histogram that represents estimates of the normalised number density and the normalised biomass density 
```{r}
binned_stomach %>% 
  ggplot(aes(l, Density, fill = Type)) +
  geom_col(position = "dodge") +
  facet_grid(rows = vars(Species), scales = "free_y") +
  xlab("Log of Predator/Prey mass ratio") +
  expand_limits(x = c(0, 30))
```
          
## Kernal Density Estimation 
```{r}
adjust <- 1/2  # decrease bandwidth for kernel estimate
stomach <- stomach %>% 
  group_by(Species) %>% 
  mutate(weight_numbers = Nprey / sum(Nprey),
         weight_biomass = Nprey * wprey / sum(Nprey * wprey))
ggplot(stomach) +
  geom_density(aes(l, weight = weight_numbers,
                   fill = "Numbers"),
               adjust = adjust) +
  geom_density(aes(l, weight = weight_biomass,
                   fill = "Biomass"),
               adjust = adjust) +
  facet_grid(rows = vars(Species), scales = "free_y") +
  xlab("Log of predator/prey mass ratio") +
  expand_limits(x = c(0, 29))
```
         
## Gaussian Distribution fit
Plotting the normal distribution for numbers 
```{r}
weighted.sd <- function(x, w) {
  sqrt(sum(w * (x - weighted.mean(x, w))^2))
}
fit <- stomach %>% 
  summarise(mean = weighted.mean(l, weight_numbers),
            sd = weighted.sd(l, weight_numbers))
stomach %>% 
  ggplot() +
  geom_density(aes(l, weight = weight_numbers),
               fill = "#00BFC4", adjust = adjust) +
  xlab("Log of Predator/Prey mass ratio") +
  stat_function(fun = dnorm, 
                args = list(mean = fit$mean, 
                            sd = fit$sd), 
                colour = "blue") +
  expand_limits(x = c(6, 30))
```
         
Now adding biomass
```{r}
stomach %>% 
  ggplot() +
  geom_density(aes(l, weight = weight_numbers,
                   fill = "Numbers"),
               adjust = adjust) +
  geom_density(aes(l, weight = weight_biomass,
                   fill = "Biomass"),
               adjust = adjust) +
  xlab("Log of Predator/Prey mass ratio") +
  stat_function(fun = dnorm, 
                args = list(mean = fit$mean, 
                            sd = fit$sd), 
                colour = "blue") +
  stat_function(fun = dnorm, 
                args = list(mean = fit$mean - fit$sd^2, 
                            sd = fit$sd), 
                colour = "red") +
  expand_limits(x = c(0, 30))
```

```{r}
weighted.sd <- function(x, w) {
  sqrt(sum(w * (x - weighted.mean(x, w))^2))
}
fit <- stomach %>% 
  summarise(mean = weighted.mean(l, weight_numbers),
            sd = weighted.sd(l, weight_numbers))
stomach %>% 
  ggplot() +
  geom_density(aes(l, weight = weight_numbers,
                   fill = "Numbers"),
               adjust = adjust) +
  geom_density(aes(l, weight = weight_biomass,
                   fill = "Biomass"),
               adjust = adjust) +
  xlab("Log of Predator/Prey mass ratio") +
  stat_function(fun = dnorm, 
                args = list(mean = fit$mean, 
                            sd = fit$sd), 
                colour = "blue") +
  stat_function(fun = dnorm, 
                args = list(mean = fit$mean - fit$sd^2, 
                            sd = fit$sd), 
                colour = "red") +
  expand_limits(x = c(0, 30))
```

Applying Gaussian Mixture Models in different ways 
First way by calculating each individual PPMR by numbers and biomass and then applying the EM algorithm to find the estimated parameters and then plotting 
```{r}
ppmr <- stomach %>%
  mutate(numbers = log(wpredator/(wprey * sum(Nprey))),
         biomass = log(wpredator*sum(Nprey)/wprey)) 
library(mixtools)
my_mix1 <- normalmixEM(ppmr$numbers, k = 2)
plot(my_mix1, which = 2)
my_mix2 <- normalmixEM(ppmr$biomass, k = 2)
plot(my_mix2, which = 2)
my_mix1$lambda
my_mix1$mu
my_mix1$sigma
my_mix2$lambda
my_mix2$mu
my_mix2$sigma
#plot of numbers 
ggplot(ppmr, aes(x = numbers)) +
  geom_histogram(binwidth = binsize) +
  mapply(
    function(mean, sd, lambda, n, binwidth) {
      stat_function(
        fun = function(x) {
          (dnorm(x, mean = mean, sd = sd)) * n * binwidth * lambda
        }
      )
    },
    mean = my_mix1[["mu"]], #mean
    sd = my_mix1[["sigma"]], #standard deviation
    lambda = my_mix1[["lambda"]], #amplitude
    n = length(ppmr$numbers), #sample size
    binwidth = binsize #binwidth used for histogram
  )
#plot of biomass
ggplot(ppmr, aes(x = biomass)) +
  geom_histogram(binwidth = binsize) +
  mapply(
    function(mean, sd, lambda, n, binwidth) {
      stat_function(
        fun = function(x) {
          (dnorm(x, mean = mean, sd = sd)) * n * binwidth * lambda
        }
      )
    },
    mean = my_mix2[["mu"]], #mean
    sd = my_mix2[["sigma"]], #standard deviation
    lambda = my_mix2[["lambda"]], #amplitude
    n = length(ppmr$biomass), #sample size
    binwidth = binsize #binwidth used for histogram
  )
```

Second Method - not sure if this is correct 
Estimating the parameters for log PPMR and adjusting these for numbers and biomass, depending on the shift they have on the orginal plot of the log of the PPMR 

```{r}
my_mix <- normalmixEM(stomach$l, k = 2)
plot(my_mix, which = 2)
my_mix$lambda
my_mix$mu
my_mix$sigma

#plot of the log PPMR with the estimated parameters 

ggplot(stomach, aes(x = l)) +
  geom_histogram(binwidth = binsize) +
  mapply(
    function(mean, sd, lambda, n, binwidth) {
      stat_function(
        fun = function(x) {
          (dnorm(x, mean = mean, sd = sd)) * n * binwidth * lambda
        }
      )
    },
    mean = my_mix[["mu"]], #mean
    sd = my_mix[["sigma"]], #standard deviation
    lambda = my_mix[["lambda"]], #amplitude
    n = length(stomach$l), #sample size
    binwidth = binsize #binwidth used for histogram
  )


#how found the mean and sd of l and the difference in weightings
fit <- stomach %>% 
  summarise(mean = weighted.mean(l, weight_numbers),
            sd = weighted.sd(l, weight_numbers))
mean(stomach$l)
sd(stomach$l)

#then figured out the shift that the weighting of numbers and biomass had on the mean and standard deviation in the orginal plot 
#used this difference to then add or subtract the difference from the new estimated parameters 
#plotted these on the original plot of the log of PPMR with the weighting of numbers and biomass 

stomach %>% 
  ggplot() +
  geom_density(aes(l,weight = weight_numbers, 
                   fill = "Numbers"),
               adjust = adjust) +
  geom_density(aes(l, weight = weight_biomass,
                   fill = "Biomass"),
               adjust = adjust) +
  xlab("Log of Predator/Prey mass ratio") +
  stat_function(fun = dnorm, 
                args = list(mean = 4.344325, 
                            sd = 0.984058), 
                colour = "blue") +
  stat_function(fun = dnorm, 
                args = list(mean = 9.370544, 
                            sd = 0.993544), 
                colour = "blue") +
  stat_function(fun = dnorm, 
                args = list(mean = -0.464636, 
                            sd = 0.984058), 
                colour = "red") +
  stat_function(fun = dnorm, 
                args = list(mean = 4.561583, 
                            sd = 0.993544), 
                colour = "red") 
```




